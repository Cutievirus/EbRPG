PIXI.DisplayObject.prototype.enabled=!0,PIXI.DisplayObject.prototype.enable=function(){this.enabled=!0,this.visible=!0},PIXI.DisplayObject.prototype.disable=function(){this.enabled=!1,this.visible=!1},PIXI.DisplayObject.prototype.update=function(e){},PIXI.DisplayObject.prototype.zIndex=0,PIXI.Container.prototype.update=function(e){this.children.sort((e,t)=>e.zIndex-t.zIndex);for(const t of this.children)t.update(e)},Object.defineProperty(PIXI.DisplayObject.prototype,"scene",{get(){let e=this;for(;!(e instanceof Filament.Scene)&&e.parent;)e=e.parent;return e instanceof Filament.Scene?e:null},set(e){this.scene!==e&&e.addChild(this)}}),PIXI.Texture.prototype.crop=function(e,t,i,n){const s=1===arguments.length?e:new PIXI.Rectangle(e,t,i,n);return new PIXI.Texture(this.baseTexture,s)},PIXI.Sprite.prototype.crop=function(){this.texture=this.texture.crop(...arguments)},Filament.BLEND_MODES={},Filament.addBlendMode=function(e,t){const i=Filament.pixi.renderer.state.blendModes;Filament.BLEND_MODES[e]=i.length,i.push(t)},Filament.Enum=class{constructor(...e){for(const t of e)this[t]=t}},Filament.SCALE_MODE=new Filament.Enum("NORMAL","NEAREST","HYBRID"),Filament.settings={width:320,height:240,tileSize:16,cellSize:24,scaleMode:Filament.SCALE_MODE.HYBRID,maintainAspectRatio:!0,uiRes:1,language:"en"},Filament.configure=(e=>{Object.assign(Filament.settings,e)}),Filament.loadSettings=async function(){const e=await(await fetch(Filament.gameFile("settings.json"))).json();Filament.configure(e);const t=document.body.style;t.setProperty("--uiRes",Filament.settings.uiRes),t.setProperty("--screen-width",Filament.settings.width),t.setProperty("--screen-height",Filament.settings.height),t.setProperty("--tileSize",Filament.settings.tileSize)},Object.defineProperties(Filament,{pixiScaleMode:{get:()=>Filament.settings.scaleMode===Filament.SCALE_MODE.NORMAL?PIXI.SCALE_MODES.LINEAR:PIXI.SCALE_MODES.NEAREST}}),Filament.truncateNumber=(e=>{if(e<=99999)return e+"";let t=0;for(;e>9999&&t<5;)e/=1e3,++t;return Math.floor(e)+Filament.LARGE_NUMBER_ABBREVIATIONS[t]}),Filament.LARGE_NUMBER_ABBREVIATIONS=["","K","M","B","T","Q"],Filament.sleep=(e=>new Promise(t=>setTimeout(t,e))),Filament.minmax=((e,t,i)=>Math.max(e,Math.min(t,i))),Filament.round=((e,t=0,i="round")=>{const n=Math.pow(10,t);return Math[i](e*n)/n}),Filament.floor=((e,t)=>Filament.round(e,t,"floor")),Filament.ceil=((e,t)=>Filament.round(e,t,"ceil")),Filament.roundFactor=((e,t=1,i="round")=>Math[i](e/t)*t),Filament.floorFactor=((e,t)=>Filament.roundFactor(e,t,"floor")),Filament.ceilFactor=((e,t)=>Filament.roundFactor(e,t,"ceil")),Filament.arrayAdd=((e,t,i=e.length)=>!(e.indexOf(t)>=0)&&(e.splice(i,0,t),!0)),Filament.arrayRemove=((e,t)=>{const i=e.indexOf(t);return i>=0&&(e.splice(i,1),!0)}),Filament.assign=((e,...t)=>{for(const i of t)for(const t in i)t in e||(e[t]=i[t])}),Filament.mixin_object=((e,t)=>{Filament.assign(e,t),"function"==typeof t.implement&&t.implement.call(e)}),Filament.mixin=((e,t)=>{if(!(e instanceof Function))return Filament.mixin_object(e,t);e._mixins||(e._mixins=[]),e._mixins.push(t),Filament.assign(e.prototype,t),e.prototype.implement=Filament.implement.bind(this)}),Filament.implement=function(e,t){if(e&&t._mixins)for(const i of t._mixins)"function"==typeof i.implement&&i.implement.call(e)},Filament.untag=((e,...t)=>{if(!(e instanceof Array))return e;let i="";for(const n in e)i+=e[n]+(t[n]||"");return i}),Filament.html=((...e)=>{const t=Filament.untag(...e),i=document.createElement("div");return i.innerHTML=t,new Filament.NodeList(...i.childNodes)}),Filament.NodeList=class extends Array{mount(e){for(const t of this)e.append(t);return this}elements(){let e=[];for(const t of this)t instanceof Element&&e.push(t);return e}},Filament.createElement=((e,t)=>{let i=e.match(/^[^\s.#[\]]+/);if(!i)throw`Couldn't find tagname in string ${e}`;const n=document.createElement(i[0]);(i=e.match(/#([^\s.#[\]]+)/))&&(n.id=i[1]);let s=/\.([^\s.#[\]]+)/g;for(;i=s.exec(e);)n.classList.add(i[1]);for(s=/\[([^\s.#[\]=]+)=([^\s.#[\]=]+)\]/g;i=s.exec(e);)n.setAttribute(i[1],i[2]);return t&&n.append(t),n.mount=Filament.mountElement,n}),Filament.mountElement=function(e){if(this instanceof Element)return e.append(this),this};{const e={construct:()=>e};Filament.isConstructor=(t=>{try{return Boolean(new new Proxy(t,e))}catch(e){return!1}})}Filament.CoordMap=class{constructor(e=2,t=null,...i){this.dimensions=e,this.dfault=t,this.defaultArgs=i,this.data={}}get(e,...t){return this.dimensions<=1?this._getValue(e):this._getSubDimension(e).get(...t)}_getValue(e){if(e in this.data)return this.data[e];if("function"==typeof this.dfault){let t;return t=Filament.isConstructor(this.dfault)?new this.dfault(...this.defaultArgs):this.dfault(...this.defaultArgs),this.data[e]=t}return this.dfault}_getSubDimension(e){return this.data[e]instanceof Filament.CoordMap||(this.data[e]=new Filament.CoordMap(this.dimensions-1,this.dfault,...this.defaultArgs)),this.data[e]}set(e,...t){this.dimensions<=1?this.data[e]=t[0]:this._getSubDimension(e).set(...t)}unset(e,...t){if(this.dimensions<=1)return void delete this.data[e];const i=this._getSubDimension(e);i.unset(...t),0===Object.keys(i.data).length&&delete this.data[e]}has(e,...t){return this.dimensions<=1?e in this.data:e in this.data&&this._getSubDimension(e).has(...t)}},Filament.pixiCanvas=document.querySelector("#screen-game canvas"),Filament.parent=Filament.pixiCanvas.parentElement,Filament.ui_container=document.getElementById("ui-container"),Filament.pixi=new PIXI.Application({view:Filament.pixiCanvas,width:Filament.settings.width,height:Filament.settings.height,backgroundColor:136}),Filament.start=async function(){await Filament.loadSettings(),Filament.pixiContext=Filament.pixiCanvas.getContext("2d"),Filament.settings.scaleMode===Filament.SCALE_MODE.HYBRID&&(Filament.hybridCanvas=document.createElement("canvas"),Filament.hybridContext=Filament.hybridCanvas.getContext("2d"),Filament.hybridCanvas.id="hybrid-canvas",Filament.pixiCanvas.parentElement.appendChild(Filament.hybridCanvas),Filament.pixiCanvas.style.opacity=0),Filament.ui_container.style.width=Filament.settings.width*Filament.settings.uiRes+"px",Filament.ui_container.style.height=Filament.settings.height*Filament.settings.uiRes+"px",window.addEventListener("resize",Filament.electron?async()=>{if(Filament.resize(),!Filament.resizing){Filament.resizing=!0;for(let e=0;e<10;++e)Filament.resize(),await Filament.sleep(0);Filament.resizing=!1}}:Filament.resize),Filament.resize(),Filament.ticker=Filament.pixi.ticker.add(Filament.update,Filament),Filament.events.fireEvent("start");for(const e of Object.values(Filament.scenes))e.start()},Filament.update=(()=>{const e=Filament.ticker.elapsedMS/1e3;Filament.scene&&(Filament.scene.update(e),Filament.scene.updateUI(e)),Filament.hybridCanvas&&(Filament.pixi.render(),Filament.hybridContext.drawImage(Filament.pixiCanvas,0,0,Filament.settings.width,Filament.settings.height,0,0,Filament.hybridCanvas.width,Filament.hybridCanvas.height))}),Filament.roundScale=(e=>Math.round(e)||1),Filament.resize=(()=>{let e=Filament.parent.offsetWidth/Filament.settings.width,t=Filament.parent.offsetHeight/Filament.settings.height,i=Math.min(e,t);if(Filament.settings.maintainAspectRatio)e=t=i;else{let e=Filament.parent.offsetWidth/Filament.parent.offsetHeight;e>Filament.settings.width/Filament.settings.height?Filament.pixi.renderer.resize(Filament.settings.height*e,Filament.settings.height):Filament.pixi.renderer.resize(Filament.settings.width,Filament.settings.width/e)}Filament.scaleX=e,Filament.scaleY=t,Filament.scale=i,document.body.style.setProperty("--scale",i),Filament.pixiCanvas.style.width=Filament.settings.width*e+"px",Filament.pixiCanvas.style.height=Filament.settings.height*t+"px",Filament.hybridCanvas&&(Filament.hybridCanvas.width=Filament.settings.width*Filament.roundScale(e),Filament.hybridCanvas.height=Filament.settings.height*Filament.roundScale(t),Filament.hybridCanvas.style.width=Filament.pixiCanvas.style.width,Filament.hybridCanvas.style.height=Filament.pixiCanvas.style.height,Filament.hybridContext.imageSmoothingEnabled=!1),Filament.ui_container.style.setProperty("--scale",i/Filament.settings.uiRes),Filament.ui_container.style.setProperty("--left",Filament.parent.offsetWidth/2-Filament.ui_container.offsetWidth/2),Filament.ui_container.style.setProperty("--top",Filament.parent.offsetHeight/2-Filament.ui_container.offsetHeight/2),Filament.events.fireEvent("resize")}),Filament.MixinEvents={implement(){this.events={}},getEventList(e,t){return e in this.events||!t||(this.events[e]=[]),this.events[e]},fireEvent(e,t={}){const i=this.getEventList(e,!1);if(i)for(const n of i){if(t.remove=Filament.MixinEvents.removeEvent.bind(this,e,n),n.context instanceof PIXI.DisplayObject){const e=n.context.scene;if(!e){t.remove();continue}if(e!==Filament.scene)continue}"function"==typeof n.callback&&n.callback.call(n.context,t)}},addEvent(e,t,i){const n={callback:t,context:i};return Filament.arrayAdd(this.getEventList(e,!0),n),n},removeEvent(e,t){const i=this.getEventList(e,!1);return!!i&&Filament.arrayRemove(i,t)}},Filament.MixinEventHandler={eventHandler(e,t){"function"==typeof this.fireEvent&&this.fireEvent(e,t)},addEventHandler(e,t=Filament.parent){const i=`${e}Handler`;this[i]=this.eventHandler.bind(this,e),t instanceof Object&&"addEventListener"in t&&t.addEventListener(e,this[i])}},Filament.events={},Filament.mixin_object(Filament.events,Filament.MixinEvents),Filament.MixinUtil={mount(e){return e.addChild(this),this},assign(e,t){return"object"==typeof arguments[0]?Object.assign(this,arguments[0]):this[e]=t,this}},Filament.mixin(PIXI.DisplayObject,Filament.MixinUtil),Filament.keyboard={keys:{},eventHandler(e,t){const i=this.getKey(t.code,!1);if(i){"function"==typeof i[e]&&i[e]();for(const n of i.keygroups)n.fireEvent(e,t)}},getKey(e,t){return e in this.keys||!t||(this.keys[e]=new Filament.Key(e)),this.keys[e]}},Filament.mixin_object(Filament.keyboard,Filament.MixinEventHandler),Filament.keyboard.addEventHandler("keydown"),Filament.keyboard.addEventHandler("keyup"),Filament.Key=class{constructor(e){this.name=e,this.isDown=!1,this.keygroups=[]}keydown(){this.isDown=!0}keyup(){this.isDown=!1}},Filament.keys={},Filament.KeyGroup=class{constructor(e,t=[]){this.name=e,Filament.keys[e]=this,this.keys=[];for(const e of t)this.addKey(e);this.implement(this,Filament.KeyGroup)}addKey(e){const t=Filament.keyboard.getKey(e,!0);Filament.arrayAdd(t.keygroups,this),Filament.arrayAdd(this.keys,t)}removeKey(e){const t=Filament.keyboard.getKey(e,!1);t&&(Filament.arrayRemove(t.keygroups,this),Filament.arrayRemove(this.keys,t))}get isDown(){for(const e in this.keys)if(e.isDown)return!0;return!1}},Filament.mixin(Filament.KeyGroup,Filament.MixinEvents),new Filament.KeyGroup("CONFIRM",["Enter","Space"]),new Filament.KeyGroup("CANCEL",["Escape"]),new Filament.KeyGroup("UP",["ArrowUp","KeyW"]),new Filament.KeyGroup("LEFT",["ArrowLeft","KeyA"]),new Filament.KeyGroup("DOWN",["ArrowDown","KeyS"]),new Filament.KeyGroup("RIGHT",["ArrowRight","KeyD"]),Filament.mouse={eventHandler(e,t){const i=Filament.pixiCanvas.getBoundingClientRect();t.canvasX=(t.clientX-i.x)/Filament.scaleX,t.canvasY=(t.clientY-i.y)/Filament.scaleY,t.worldX=t.canvasX,t.worldY=t.canvasY,this.fireEvent(e,t)}},Filament.mixin_object(Filament.mouse,Filament.MixinEvents),Filament.mixin_object(Filament.mouse,Filament.MixinEventHandler),Filament.mouse.addEventHandler("click"),Filament.mouse.addEventHandler("dblclick"),Filament.mouse.addEventHandler("mousedown"),Filament.mouse.addEventHandler("mouseup",window),Filament.mouse.addEventHandler("mousemove"),Filament.mouse.addEvent("mousedown",e=>{Filament.mouse.isDown=!0}),Filament.mouse.addEvent("mouseup",e=>{Filament.mouse.isDown=!1}),Filament.Cache=class{constructor(){this._cache={}}async requestImage(e,t="assets/images"){return await this.gameAsset(e,t,e=>(e.texture.baseTexture.scaleMode=Filament.pixiScaleMode,e.texture))}async requestAudio(e){}async requestJSON(e,t="data"){return await this.gameAsset(e,t,e=>e.data)}async requestTileset(e){const t=await this.requestJSON(`tilesets/${e}.json`),i=await this.requestImage(t.image,"assets/tilesets");return new Filament.TileSet(i,t)}async gameAsset(e,t,i){return t=Filament.path(t,e),await this.requestAsset(t,Filament.gameFile(t),i)}requestAsset(e,t,i){return new Promise((n,s)=>{this._cache[e]||(this._cache[e]=new Filament.AssetLoader(e,t,this)),this._cache[e]instanceof Filament.AssetLoader?this._cache[e].addRequest(n,s,i):n(i(this._cache[e]))})}},Filament.cache=new Filament.Cache,Filament.AssetLoader=class extends PIXI.loaders.Loader{constructor(e,t,i){super(),this.add(e,t),this._requests=[],this.load((t,n)=>{const s=n[e];for(const e of this._requests)s.error?e.reject(s.error):e.resolve(e.callback(s));s.error?delete i._cache[e]:i._cache[e]=s})}addRequest(e,t,i){this._requests.push(new Filament.AssetRequest(e,t,i))}},Filament.AssetRequest=class{constructor(e,t,i){this.resolve=e,this.reject=t,this.callback=i}},Filament.UI=class extends PIXI.Container{constructor(){super(),this.ui=document.createElement("div"),this.anchor=new PIXI.ObservablePoint(this._onAnchorUpdate,this),this.setAccessor("id"),this.setAccessor("className"),this.classList=this.ui.classList,this.style=this.ui.style,this.style.position="absolute"}mount(e){return e.addChild(this),this}mountUI(e){return(e instanceof Filament.UI?e.ui:e).append(this.ui),this}setAccessor(e,t=e){Object.defineProperty(this,e,{get(){return this.ui[t]},set(e){this.ui[t]=e}})}enable(){super.enable(),this.setAttribute("data-enabled",!0)}disable(){super.disable(),this.setAttribute("data-enabled",!1)}destroy(){super.destroy(),this.ui.parentNode.removeChild(this.ui)}setAttribute(e,t){t=String(t),this.ui.getAttribute(e)!==t&&this.ui.setAttribute(e,t)}setProperty(e,t){t=String(t),this.ui.style.getPropertyValue(e)!==t&&this.ui.style.setProperty(e,t)}setAttributes(e){for(const t in e)this.setAttribute(t,e[t])}setProperties(e){for(const t in e)this.setProperty(t,e[t])}updateUI(e){this.setAttribute("data-visible",this.worldVisible),!this.ui.parentNode&&this.scene&&this.scene!==this&&this.mountUI(this.scene)}_onAnchorUpdate(){}},Filament.Battler=class{constructor(){this.stats={lethality:0,resilience:0,haste:0,spirit:0,luck:0}}},Filament.Sprite=class extends PIXI.Sprite{constructor(e){super(PIXI.Texture.EMPTY),this.loadTexture(e)}async loadTexture(e){this.texture=await Filament.cache.requestImage(e)}},Filament.scenes={},Filament.activeScene="home",Object.defineProperty(Filament,"scene",{get:()=>Filament.scenes[Filament.activeScene]||Filament.scenes.home,set(e){const t=Filament.activeScene;if(e in Filament.scenes)Filament.activeScene=e;else for(const t in Filament.scenes)if(e===Filament.scenes[t]){Filament.activeScene=t;break}if(Filament.activeScene!==t)for(const e in Filament.scenes){const t=Filament.scenes[e];Filament.activeScene===t.name?(t.enable(),t.enter()):t.enabled&&(t.disable(),t.leave())}}}),Filament.ui_container=document.getElementById("ui-container"),Filament.Scene=class extends Filament.UI{constructor(e){super(),this.mountUI(Filament.ui_container),this.mount(Filament.pixi.stage),Filament.scenes[e]=this,this.id="scene-"+e,this.classList.add("scene"),this.name=e,this.windows=[],this.setAttribute("data-visible",!1)}enable(){super.enable(),this.setAttribute("data-visible",!0)}disable(){super.disable(),this.setAttribute("data-visible",!1)}updateUI(e){super.updateUI(e);for(let t=this.windows.length-1;t>=0;--t)this.windows[t].updateUI(e)}start(){}enter(){}leave(){}},Filament.Window=class extends Filament.UI{constructor(){super(),this.classList.add("window"),this.ui_width=20,this.ui_height=20,this.minwidth=20,this.minheight=20,this.maxwidth=Filament.settings.width,this.maxheight=Filament.settings.height,this._hasFrame=!1,this._interactive=!1,this.movable=!1,this.resizable=!1,this.closable=!1,this.edgeSnap=!0,this.content=Filament.createElement("div.content").mount(this.ui),this.handle=Filament.createElement("div.handle").mount(this.ui),this.closeButton=Filament.createElement("div.closeButton","×").mount(this.ui),this.closeButton.addEventListener("click",e=>{this.destroy()}),this.teletype=0,this.handle.addEventListener("mousedown",e=>{Filament.arrayRemove(this.scene.windows,this),Filament.arrayAdd(this.scene.windows,this),this.dragging=!0}),this.handle.addEventListener("mouseup",e=>{this.dragging=!1,this.finishDrag(e)}),this.contentObserver=new MutationObserver(()=>{this.resizable&&(this.content.style.width||this.content.style.height)&&(this.content.style.width="",this.content.style.height="",this.resizing=!0)}),this.contentObserver.observe(this.content,{attributes:!0,attributeFilter:["style"]})}mount(e){return super.mount(e),e.scene&&this.mountUI(this.scene),this}mountUI(e){return this.scene&&Filament.arrayRemove(this.scene.windows,this),super.mountUI(e),Filament.arrayAdd(e.windows,this),this}destroy(){this.scene&&Filament.arrayRemove(this.scene.windows,this),super.destroy(...arguments)}get width(){return this.ui_width}set width(e){this.ui_width=e}get height(){return this.ui_height}set height(e){this.ui_height=e}get interactive(){return this._interactive||this.movable||this.resizable||this.closable}set interactive(e){this._interactive=e}get hasFrame(){return this._hasFrame||this.movable||this.resizable||this.closable}set hasFrame(e){this._hasFrame=e}getBoundsUI(){let e={};return e.width=Filament.round(this.width,2),e.height=Filament.round(this.height,2),e.left=Filament.round(this.worldTransform.tx-this.anchor.x*e.width,2),e.top=Filament.round(this.worldTransform.ty-this.anchor.y*e.height,2),this.edgeSnap&&(e.left=Filament.minmax(0,Filament.settings.width-e.width,e.left),e.top=Filament.minmax(0,Filament.settings.height-e.height,e.top)),e}updateUI(e){super.updateUI(e),this.resizable&&(this.width=Filament.minmax(this.minwidth,this.maxwidth,this.width),this.height=Filament.minmax(this.minheight,this.maxheight,this.height));let t=this.getBoundsUI(!0);const i=this.scene.windows.indexOf(this);this.setProperties({"--width":t.width,"--height":t.height,"--x":t.left,"--y":t.top,"--z":this.zIndex+i/1e3,"--alpha":this.worldAlpha}),this.setAttributes({"data-frame":this.hasFrame,"data-interactive":this.interactive,"data-movable":this.movable,"data-resizable":this.resizable,"data-closable":this.closable})}updateDrag(e){this.x+=e.movementX/Filament.scale,this.y+=e.movementY/Filament.scale}finishDrag(e){this.edgeSnap&&(this.x=Filament.minmax(0,Filament.settings.width-this.width,this.x),this.y=Filament.minmax(0,Filament.settings.height-this.height,this.y))}updateResize(e){this.width=Math.min(Filament.settings.width-this.x,this.width+e.movementX/Filament.scale),this.height=Math.min(Filament.settings.height-this.y,this.height+e.movementY/Filament.scale),this.resizing=!1}get text(){return this.content.innerHTML}set text(e){}},window.addEventListener("mousemove",e=>{if(Filament.scene)for(const t of Filament.scene.windows)t.dragging&&t.updateDrag(e),t.resizing&&t.updateResize(e)}),window.addEventListener("mouseup",e=>{if(Filament.scene)for(const e of Filament.scene.windows)e.dragging=!1,e.finishDrag()}),new Filament.Scene("home"),Filament.scenes.home.start=function(){this.window=(new Filament.Window).mount(this),this.window.width=100,this.window.height=50,this.window.x=50,this.window.y=75,this.window.resizable=!0,this.window.movable=!0,this.window.closable=!0,this.window.content.innerHTML="Welcome to Filament!<br>\n\t<a href=\"javascript:void(Filament.scene='map');\">Map</a>",new Filament.Sprite("ebby.png").mount(this).assign({alpha:.6}),new Filament.Sprite("ebby.png").mount(this).assign({x:20})},Filament.scenes.home.update=function(){},new Filament.Scene("map"),Filament.scenes.map.start=function(){Filament.map=(new Filament.TileMap).mount(this)},Filament.scenes.map.update=function(){},Filament.TileMap=class extends PIXI.Container{constructor(){super(),this.baseLayer=(new PIXI.Container).mount(this),this.actorLayer=(new PIXI.Container).mount(this),this.fringeLayer=(new PIXI.Container).mount(this),this.cells=new Filament.CoordMap(2,Filament.MapCell,this),this.selector=new Filament.TileSelector(this).mount(this),this.settings={name:"",cellSize:null}}get cellSize(){return this.settings.cellSize?this.settings.cellSize:Filament.settings.cellSize}mount(){super.mount(...arguments),this.selector.mountUI(this.scene)}},Filament.createTileEraser=function(){Filament.tileEraser=new PIXI.Graphics,Filament.tileEraser.beginFill(0);const e=Filament.settings.tileSize;Filament.tileEraser.drawRect(0,0,e,e),Filament.tileEraser.endFill(),Filament.tileEraser.blendMode=Filament.BLEND_MODES.ERASE},Filament.getEraser=function(e,t){const i=Filament.settings.tileSize;return Filament.tileEraser.position.set(e*i,t*i),Filament.tileEraser},Filament.events.addEvent("start",()=>{Filament.addBlendMode("ERASE",[0,WebGLRenderingContext.ONE_MINUS_SRC_ALPHA]),Filament.createTileEraser()}),Filament.TileSet=class{constructor(e,t){this.image=e,this.data=t,this.stamp=new PIXI.Sprite(e)}getStamp(e,t,i,n){const s=this.data.tileSize;return this.stamp.crop(e*s,t*s,s,s),this.stamp.position.set(i*s,n*s),this.stamp}getTile(e,t){const i=this.data.data[t];i||(i=[]);let n=i[e];if(null==n&&(n={data:0}),"number"==typeof n)n={data:n};else if(n.passage)return n;return n.passage=15&n.data,n.opaque=n.data>>>4&1,n.layer=n.data>>>5&7,n.terrain=n.data>>>8,i[e]=n,n}},Filament.TileSelector=class extends Filament.Window{constructor(e){super(),this.tilemap=e,this.classList.add("tileSelector"),this.minwidth=0,this.minheight=0,this.width=Filament.settings.tileSize,this.height=Filament.settings.tileSize,this.edgeSnap=!0,this.tileX=0,this.tileY=0,this.rightclicked=!1,Filament.mouse.addEvent("mousemove",this.mousemove,this),Filament.mouse.addEvent("mousedown",this.mousedown,this)}mousemove(e){this.tileX=Math.floor(e.worldX/Filament.settings.tileSize),this.tileY=Math.floor(e.worldY/Filament.settings.tileSize),this.x=this.tileX*Filament.settings.tileSize,this.y=this.tileY*Filament.settings.tileSize,Filament.mouse.isDown&&this.placeTile(e)}mousedown(e){this.rightclicked=e.button>0,this.placeTile(e)}placeTile(e){const t=Math.floor(this.tileX/this.tilemap.cellSize),i=Math.floor(this.tileY/this.tilemap.cellSize),n=this.tilemap.cells.get(t,i),s=this.tileX%this.tilemap.cellSize,a=this.tileY%this.tilemap.cellSize,l=n.getTileStack(s,a);n.clearTile(s,a),this.rightclicked?l.length=0:(l[0]={ts:0,x:0,y:0},n.loadTileStack(s,a,l))}},Filament.PLACEMENT_MODE=new Filament.Enum("PEN","ERASE","FILL","RECT","CLONE"),Filament.MapCell=class{constructor(e){this.tilemap=e,this.baseLayer=new Filament.MapCellLayer(e),this.fringeLayer=new Filament.MapCellLayer(e),e.baseLayer.addChild(this.baseLayer),e.fringeLayer.addChild(this.fringeLayer),this.loaded=!1,this.lastTileset=0,this.load()}getTileStack(e,t){const i=e+t*this.tilemap.cellSize;return this.data[i]instanceof Array||(this.data[i]=[this.data[i]]),this.data[i]}async load(){this.data=[],this.actors=[];for(let e=0;e<this.tilemap.cellSize;++e)for(let t=0;t<this.tilemap.cellSize;++t)await this.loadTileStack(t,e);this.loaded=!0}async loadTileStack(e,t,i=this.getTileStack(e,t)){for(const n of i)await this.loadTile(n,e,t)}async loadTile(e,t,i){if(!e)return;const n="ts"in e?e.ts:this.lastTileset;n!==this.lastTileset&&(this.lastTileset=n);const s=e.x,a=e.y,l=await Filament.cache.requestTileset(n);switch(l.getTile(s,a).layer){case 0:this.baseLayer.drawTile(l,s,a,t,i)}}clearTile(e,t){this.baseLayer.clearTile(e,t),this.fringeLayer.clearTile(e,t)}unload(){this.baseLayer.destroy(),this.fringeLayer.destroy()}},Filament.MapCellLayer=class extends PIXI.Sprite{constructor(e){super(new Filament.MapCellTexture(e)),this.tilemap=e}destroy(){super.destroy(...arguments),this.texture.destroy()}drawTile(e,t,i,n,s){const a=e.getStamp(t,i,n,s);Filament.pixi.renderer.render(a,this.texture,!1)}clearTile(e,t){const i=Filament.getEraser(e,t);Filament.pixi.renderer.render(i,this.texture,!1)}},Filament.MapCellTexture=class extends PIXI.RenderTexture{constructor(e){super(new PIXI.BaseRenderTexture(Filament.settings.tileSize*e.cellSize,Filament.settings.tileSize*e.cellSize,Filament.pixiScaleMode)),this.tilemap=e}};
//# sourceMappingURL=engine.js.map
